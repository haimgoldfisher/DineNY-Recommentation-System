{% extends "layout.html" %}
{% block title %}Restaurants{% endblock %}
{% block content %}
<h1>Restaurants</h1>
<form method="get" action="{{ url_for('restaurants') }}" class="search-form">
    <input type="text" name="search" placeholder="Search by name" value="{{ search_query }}">
    <div class="sort-buttons">
        <button type="submit" name="order_by" value="Rating" class="btn-primary {% if order_by == 'Rating' %}active{% endif %}">Sort by Rating</button>
        <button type="submit" name="order_by" value="Reviews" class="btn-primary {% if order_by == 'Reviews' %}active{% endif %}">Sort by Reviews</button>
    </div>
    <button type="submit" class="btn-primary">Search</button>
</form>
<div class="restaurant-list">
    {% for restaurant in restaurants %}
    <div class="restaurant-block" onclick="showRestaurantDetails('{{ restaurant.gmap_id }}')">
        <h2 class="restaurant-name">{{ restaurant.name }}</h2>
        <img src="{{ restaurant.img_url }}" alt="Restaurant Image">
        <div class="restaurant-info">
            <span class="rating">‚≠ê {{ '{:.1f}'.format(restaurant.Rating) }}</span>
            <span class="reviews">üìù {{ restaurant.Reviews }}</span>
        </div>
    </div>
    {% endfor %}
</div>
<div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('restaurants', page=page-1, search=search_query, order_by=order_by) }}">Previous</a>
    {% endif %}
    Page {{ page }} of {{ total_pages }}
    {% if page < total_pages %}
    <a href="{{ url_for('restaurants', page=page+1, search=search_query, order_by=order_by) }}">Next</a>
    {% endif %}
</div>

<!-- Popup HTML -->
<div id="restaurantPopup" class="form-popup">
    <div class="form-container">
        <button class="close-button" onclick="closePopup()">X</button>
        <h1 id="popupTitle">Restaurant Details</h1>
        <img id="popupImage" src="" alt="Restaurant Image">
        <div id="popupInfo"></div>
        <div class="star-rating">
            <img class="star" src="{{ url_for('static', filename='imgs/star-off.png') }}" data-value="1" alt="Star 1">
            <img class="star" src="{{ url_for('static', filename='imgs/star-off.png') }}" data-value="2" alt="Star 2">
            <img class="star" src="{{ url_for('static', filename='imgs/star-off.png') }}" data-value="3" alt="Star 3">
            <img class="star" src="{{ url_for('static', filename='imgs/star-off.png') }}" data-value="4" alt="Star 4">
            <img class="star" src="{{ url_for('static', filename='imgs/star-off.png') }}" data-value="5" alt="Star 5">
        </div>
    </div>
</div>

<!-- Confirmation Popup -->
<div id="confirmationPopup" class="form-popup">
    <div class="form-container">
        <h1>Confirm Rating</h1>
        <p>Are you sure you want to give <span id="ratingValue"></span> rating?</p>
        <div class="confirmation-buttons">
            <button type="button" class="btn-primary" onclick="submitRating()">Yes</button>
            <button type="button" class="btn cancel" onclick="closeConfirmationPopup()">No</button>
        </div>
    </div>
</div>

<script>
    let currentRating = 0;

    function showRestaurantDetails(gmap_id) {
        fetch(`/restaurant_details/${gmap_id}`)
            .then(response => response.json())
            .then(data => {
                // Update popup content
                document.getElementById("popupTitle").innerText = data.name;
                document.getElementById("popupImage").src = data.img_url;
                const formattedRating = data.rating.toFixed(1);
                document.getElementById("popupInfo").innerHTML = `
                    <p>Address: ${data.address}</p>
                    <p>URL: <a href="${data.url}" target="_blank">Click here</a></p>
                    <p>Rating: ${formattedRating}</p>
                    <p>Reviews: ${data.reviews}</p>
                `;
                // Display the popup
                document.getElementById("restaurantPopup").style.display = "block";
            })
            .catch(error => console.error('Error fetching restaurant details:', error));
    }

    function closePopup() {
        document.getElementById("restaurantPopup").style.display = "none";
    }

    function showConfirmationPopup() {
        document.getElementById("ratingValue").innerText = currentRating;
        document.getElementById("confirmationPopup").style.display = "block";
    }

    function closeConfirmationPopup() {
        // Reset the star rating
        currentRating = 0;
        updateStars();
        document.getElementById("confirmationPopup").style.display = "none";
    }

    function submitRating() {
        alert(`You have rated ${currentRating} stars.`);
        closeConfirmationPopup();
        closePopup();
        // Implement the logic to save the rating to the backend here
    }

    // Star rating logic
    const stars = document.querySelectorAll('.star-rating .star');

    stars.forEach((star, index) => {
        star.addEventListener('click', () => {
            currentRating = index + 1;
            updateStars();
            showConfirmationPopup();
        });
        star.addEventListener('mouseover', () => {
            highlightStars(index);
        });
        star.addEventListener('mouseout', updateStars);
    });

    function highlightStars(index) {
        stars.forEach((star, i) => {
            if (i <= index) {
                star.src = "{{ url_for('static', filename='imgs/star-on.png') }}";
            } else {
                star.src = "{{ url_for('static', filename='imgs/star-off.png') }}";
            }
        });
    }

    function updateStars() {
        stars.forEach((star, i) => {
            if (i < currentRating) {
                star.src = "{{ url_for('static', filename='imgs/star-on.png') }}";
            } else {
                star.src = "{{ url_for('static', filename='imgs/star-off.png') }}";
            }
        });
    }
</script>
{% endblock %}
